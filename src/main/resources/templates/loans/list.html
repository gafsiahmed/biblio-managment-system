<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <meta charset="UTF-8">
  <title>Tous les prêts</title>
  <link rel="stylesheet" href="/css/styles.css">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    .status-badge {
      font-size: 0.75rem;
      padding: 4px 8px;
      border-radius: 9999px;
      font-weight: 500;
      display: inline-block;
    }
    .status-RESERVED { background-color: #e0f2fe; color: #0369a1; }
    .status-BORROWED { background-color: #fef3c7; color: #92400e; }
    .status-IN_PROGRESS { background-color: #dcfce7; color: #166534; }
    .status-OVERDUE { background-color: #fee2e2; color: #991b1b; }
    .status-RETURNED { background-color: #f1f5f9; color: #475569; }
    .status-CLOSED { background-color: #f1f5f9; color: #475569; }
    .status-CANCELLED { background-color: #f1f5f9; color: #94a3b8; }
  </style>
</head>
<body>
<div th:replace="~{fragments/navbar :: navbar}"></div>
<div class="layout">
  <aside th:replace="~{fragments/aside :: aside}"></aside>
  <main class="main">
    <div class="container">
      <div class="header">
        <h1 class="title">Gestion des Prêts</h1>
        <div class="stack">
          <!-- Optional filter buttons could go here -->
        </div>
      </div>

      <div class="card">
        <div style="overflow-x: auto;">
          <table style="width: 100%; border-collapse: collapse; min-width: 900px;">
            <thead>
              <tr style="border-bottom: 2px solid #f1f5f9; text-align: left;">
                <th style="padding: 12px;">N°</th>
                <th style="padding: 12px;">Utilisateur</th>
                <th style="padding: 12px;">Livre</th>
                <th style="padding: 12px;">Dates</th>
                <th style="padding: 12px;">Statut</th>
                <th style="padding: 12px;">Frais</th>
                <th style="padding: 12px; text-align: right;">Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr th:each="loan : ${loans}" style="border-bottom: 1px solid #f1f5f9;">
                <td style="padding: 12px;" th:text="${loan.loanNumber}">#</td>
                <td style="padding: 12px;">
                   <div th:text="${loan.user.firstName + ' ' + loan.user.lastName}">User</div>
                   <div style="font-size: 0.875rem; color: #64748b;" th:text="${loan.user.email}">email</div>
                </td>
                <td style="padding: 12px;">
                  <div style="font-weight: 500;" th:text="${loan.resource.title}">Title</div>
                </td>
                <td style="padding: 12px; font-size: 0.875rem;">
                  <div th:if="${loan.loanDate}">Début: <span th:text="${#temporals.format(loan.loanDate, 'dd/MM/yyyy')}"></span></div>
                  <div th:if="${loan.dueDate}" style="font-weight: 500;">Fin: <span th:text="${#temporals.format(loan.dueDate, 'dd/MM/yyyy')}"></span></div>
                </td>
                <td style="padding: 12px;">
                  <span th:class="'status-badge status-' + ${loan.status}" th:text="${loan.status}">STATUS</span>
                </td>
                <td style="padding: 12px;">
                  <span th:if="${loan.lateFee > 0}" th:text="${loan.lateFee + ' DT'}" style="color: #ef4444; font-weight: 600;"></span>
                </td>
                <td style="padding: 12px; text-align: right;">
                  <div class="stack" style="justify-content: flex-end;">
                     <!-- Edit Action (For testing/admin) -->
                     <a th:href="@{'/loans/' + ${loan.id} + '/edit'}" class="btn btn-secondary" style="font-size: 0.75rem;">Edit</a>
                     
                     <!-- Return Action -->
                     <form th:if="${loan.status.name() == 'IN_PROGRESS' || loan.status.name() == 'OVERDUE'}" 
                           th:action="@{'/loans/' + ${loan.id} + '/return'}" method="post">
                       <button type="submit" class="btn btn-secondary" style="font-size: 0.75rem;">Retour</button>
                     </form>
                     
                     <!-- Validate Reservation -->
                     <form th:if="${loan.status.name() == 'RESERVED'}" 
                           th:action="@{'/loans/' + ${loan.id} + '/approve'}" method="post">
                       <button type="submit" class="btn btn-primary" style="font-size: 0.75rem;">Valider</button>
                     </form>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </main>
</div>
</body>
</html>
