<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>Utilisateur</title>
    <link rel="stylesheet" href="/css/styles.css">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script>
        function toggleLibraryField() {
            const roleSelect = document.getElementById('role');
            const libraryGroup = document.getElementById('library-group');
            if (roleSelect.value === 'ROLE_LIBRARIAN') {
                libraryGroup.style.display = 'block';
            } else {
                libraryGroup.style.display = 'none';
            }
        }
    </script>
</head>
<body onload="toggleLibraryField()">
<div th:replace="~{fragments/navbar :: navbar}"></div>
<div class="layout">
    <aside th:replace="~{fragments/aside :: aside}"></aside>
    <main class="main">
        <div class="container">
            <div class="header">
                <h1 class="title" th:text="${userForm.id == null ? 'Nouvel Utilisateur' : 'Modifier Utilisateur'}">Utilisateur</h1>
            </div>

            <div class="card" style="margin-top: 24px;">
                <form class="form" th:action="@{${userForm.id == null ? '/users' : '/users/' + userForm.id}}" th:object="${userForm}" method="post">
                    
                    <div class="form-group">
                        <label>Nom d'utilisateur *</label>
                        <input class="input" type="text" th:field="*{username}" required />
                        <div class="error" th:if="${#fields.hasErrors('username')}" th:errors="*{username}">Erreur</div>
                    </div>

                    <div class="form-group">
                        <label>Email *</label>
                        <input class="input" type="email" th:field="*{email}" required />
                        <div class="error" th:if="${#fields.hasErrors('email')}" th:errors="*{email}">Erreur</div>
                    </div>

                    <div class="form-group">
                        <label>Mot de passe <span th:if="${userForm.id == null}">*</span> <span th:if="${userForm.id != null}" class="muted">(Laisser vide pour ne pas changer)</span></label>
                        <input class="input" type="password" th:field="*{password}" th:required="${userForm.id == null}" />
                        <div class="error" th:if="${#fields.hasErrors('password')}" th:errors="*{password}">Erreur</div>
                    </div>

                    <div class="stack" style="gap: 16px;">
                        <div class="form-group" style="flex: 1;">
                            <label>Prénom</label>
                            <input class="input" type="text" th:field="*{firstName}" />
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label>Nom</label>
                            <input class="input" type="text" th:field="*{lastName}" />
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Téléphone</label>
                        <input class="input" type="text" th:field="*{phone}" />
                    </div>

                    <div class="form-group">
                        <label>Adresse</label>
                        <input class="input" type="text" th:field="*{address}" />
                    </div>

                    <div class="form-group">
                        <label>Rôle *</label>
                        <select class="input" th:field="*{role}" id="role" onchange="toggleLibraryField()">
                            <option th:each="r : ${roles}" th:value="${r}" th:text="${r}"></option>
                        </select>
                    </div>

                    <div class="form-group" id="library-group" style="display: none;">
                        <label>Bibliothèque assignée (pour Bibliothécaire) *</label>
                        <select class="input" th:field="*{libraryId}">
                            <option value="">Sélectionner une bibliothèque</option>
                            <option th:each="lib : ${libraries}" th:value="${lib.id}" th:text="${lib.name + ' (' + lib.city + ')'}"></option>
                        </select>
                    </div>

                    <div class="stack" style="margin-top: 24px;">
                        <button class="btn btn-primary" type="submit">Enregistrer</button>
                        <a th:href="@{/users}" class="btn btn-link">Annuler</a>
                    </div>
                </form>
            </div>
        </div>
    </main>
</div>
</body>
</html>
